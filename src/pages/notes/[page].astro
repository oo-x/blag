---
import { getSortedNotes, collateTags } from '@/util/content'
import MainLayout from '@/layouts/main.astro'
import Nav from '@/components/Nav.astro'
import NoteTile from '@/components/NoteTile.astro'
import Pagination from '@/components/Pagination.astro'

import type { Page, GetStaticPathsOptions } from 'astro'
import type { CollectionEntry } from 'astro:content'

type Props = { page: Page<CollectionEntry<'notes'>> }

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
	return paginate(await getSortedNotes(), {
		pageSize: 10,
	})
}

const { page } = Astro.props
const unt = 'untagged'
const tagMap = await collateTags<number>((_, t) => (t ?? 0) + 1)
const tags = Array.from(tagMap.entries()).sort((a, b) => {
	return a[0] === unt ? 1 : b[0] === unt ? -1 : b[1] - a[1]
})
---

<MainLayout title="Blag - Notes">
	<Nav />
	<main class="mx-auto max-w-6xl px-4 py-8">
		<div class="mb-6 px-6 md:px-0">
			<h1 class="mb-3 text-4xl font-bold tracking-tight">Notes</h1>
			<p class="text-lg text-muted-foreground">Public notepad</p>
		</div>

		<div class="grid grid-cols-1 gap-4 lg:grid-cols-4">
			<div class="lg:col-span-3">
				<div class="grid gap-4">
					{page.data.map((note) => <NoteTile note={note} />)}
				</div>

				<Pagination page={page} />
			</div>

			<div class="order-last lg:order-0">
				<div class="flex flex-wrap gap-2">
					{
						tags.map(([id, count]) => (
							<a
								href={`/notes/tag/${id}/1`}
								class="group inline-flex items-center gap-2 rounded-full border border-border bg-secondary/30 px-4 py-2 hover:border-primary/50 hover:bg-secondary/50 hover:shadow-md"
							>
								<span class="group-hover:text-primary">{id}</span>
								<span class="inline-flex h-6 min-w-6 items-center justify-center rounded-full bg-muted text-xs">
									{count}
								</span>
							</a>
						))
					}
				</div>
			</div>
		</div>
	</main>
</MainLayout>
